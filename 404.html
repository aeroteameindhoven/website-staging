<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Aero Team Eindhoven Staging</title>
        <style>
            :root {
                /* Prefer dark theme */
                color-scheme: dark light;
            }
        </style>
        <script>
            /** @returns {Promise<["normal", null] | ["closed", string] | ["open", string]>} */
            async function dynamic404() {
                const path = document.location.pathname;

                const regex = /^\/preview\/pr-(?<pr>\d+)\/(?<path>.*)$/;

                const matches = regex.exec(path);

                if (matches == null) {
                    // Normal 404 page
                    return ["normal", null];
                }

                const path_fragment = matches.groups["path"];
                const pr_number = matches.groups["pr"];

                if (
                    path_fragment.length === 0 ||
                    path_fragment === "404.html"
                ) {
                    // Root of deleted pr or 404 page of deleted PR
                    return [
                        "closed",
                        `https://github.com/aeroteameindhoven/website/pull/${pr_number}`,
                    ];
                } else {
                    // 404 page of possibly existing pr
                    const response = await fetch(
                        `/preview/pr-${pr_number}/404.html`
                    );

                    if (response.ok) {
                        const body = await response.text();

                        return ["open", body];
                    }

                    return [
                        "closed",
                        `https://github.com/aeroteameindhoven/website/pull/${pr_number}`,
                    ];
                }
            }

            const promise = dynamic404();

            document.addEventListener("DOMContentLoaded", () => {
                const normal_404_page = /** @type {HTMLDivElement} */ (
                    document.getElementById("normal_404_page")
                );
                const closed_pr_page = /** @type {HTMLDivElement} */ (
                    document.getElementById("closed_pr_page")
                );
                const closed_pr_link = /** @type {HTMLAnchorElement} */ (
                    document.getElementById("closed_pr_link")
                );

                promise.then(([page_type, page_data]) => {
                    switch (page_type) {
                        case "normal": {
                            normal_404_page.hidden = false;
                            closed_pr_page.hidden = true;

                            break;
                        }
                        case "closed": {
                            normal_404_page.hidden = true;
                            closed_pr_page.hidden = false;
                            closed_pr_link.href = page_data;

                            break;
                        }
                        case "open": {
                            document.documentElement.innerHTML = page_data;

                            break;
                        }
                    }
                });
            });
        </script>
    </head>
    <body>
        <div id="normal_404_page" hidden>
            <p>There exists no content here</p>
            <nav>
                <li><a href="/">return to the root</a></li>
                <li>
                    <a href="https://aeroteameindhoven.nl">
                        return to the live site
                    </a>
                </li>
            </nav>
        </div>
        <div id="closed_pr_page" hidden>
            <p>
                This pull request is not open, or is missing a 404 page. You can
                see the pull request
                <a id="closed_pr_link">on github</a>
            </p>
            <p>
                You can also see the merged changes on the live site at
                <a href="https://aeroteameindhoven.nl">aeroteameindhoven.nl</a>
            </p>
        </div>
    </body>
</html>
